# 实验报告

## 实验截图

### 源&资源目录

![](./src.png)

### 测试文本

![](./test.png)

### 词法分析结果

![](./lex.png)

### 语法分析结果

![](./syn.png)



## 实验过程

- 自定义文法
- 构造 LR(1) DFA
- 构造 LR(1) 分析表
- 将 LR(1) 分析表代码化
- 编写程序使用分析表完成语法分析器程序
- 输入字符流，先通过词法分析器生成 Token 序列，再通过语法分析器得到规约序列

## 实验详解

### 自定义文法

- 为了防止状态数过于爆炸，精选构建了一个简单但全面的文法
  - 相同意义的 Token 仅选取一种，如算数运算符仅选用 +，逻辑运算符仅选用 &&
  - 文法中存在多种非终结符与终结符
  - 文法中存在冲突，构建分析表时会用到冲突解决的知识

$(0)S`\rightarrow S$

$(1)S\rightarrow i(C)SeS$（$i$ 指代 $if$，$e$ 指代 $else$）

$(2)S\rightarrow i(C)S$

$(3)S\rightarrow w+w​$

$(4)C\rightarrow C$ && $C$

$(5)C\rightarrow w>w$

### 类别码表

由于文法中使用到的 Token 类别远远少于此前词法分析器中规定的类别，故重设类别码表

| 类别码 | 符号串 |
| :----: | :----: |
|   0    |   if   |
|   1    |  else  |
|   2    |   (    |
|   3    |   )    |
|   4    |   +    |
|   5    |   >    |
|   6    |   &&   |
|   7    |  $w$   |

其中 $w$ 的正规表达式为

$w\rightarrow (letter|Letter|digit)+$

$letter\rightarrow a|b|c|d|e|f|g|h|i|j|k|l|m|n|o|p|q|r|s|t|u|v|w|x|y|z$

$Letter\rightarrow A|B|C|D|E|F|G|H|I|J|K|L|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z$

$digit\rightarrow0|1|2|3|4|5|6|7|8|9$

### 构建 LR(1) DFA

纯手打，生活不易，给个好评哦亲~

![](./DFA-1.png)

![](./DFA-2.png)

### LR(1) 分析表

|      |      |            |      |      |      |      |            |      |      |      |      |
| :--: | :--: | :--------: | :--: | :--: | :--: | :--: | :--------: | :--: | :--: | :--: | :--: |
|      |  i   |     e      |  (   |  )   |  +   |  >   |     &&     |  w   |  $   |  S   |  C   |
|  0   |  S2  |            |      |      |      |      |            |  S3  |      |  1   |      |
|  1   |      |            |      |      |      |      |            |      |  ac  |      |      |
|  2   |      |            |  S4  |      |      |      |            |      |      |      |      |
|  3   |      |            |      |      |  S5  |      |            |      |      |      |      |
|  4   |      |            |      |      |      |      |            |  S7  |      |      |  6   |
|  5   |      |            |      |      |      |      |            |  S8  |      |      |      |
|  6   |      |            |      |  S9  |      |      |    S10     |      |      |      |      |
|  7   |      |            |      |      |      | S11  |            |      |      |      |      |
|  8   |      |            |      |      |      |      |            |      |  r3  |      |      |
|  9   | S13  |            |      |      |      |      |            | S14  |      |  12  |      |
|  10  |      |            |      |      |      |      |            |  S7  |      |      |  15  |
|  11  |      |            |      |  r5  |      |      |     r5     | S16  |      |      |      |
|  12  |      |    S17     |      |      |      |      |            |      |  r2  |      |      |
|  13  |      |            |      | S18  |      |      |            |      |      |      |      |
|  14  |      |            |      |      | S19  |      |            |      |      |      |      |
|  15  |      |            |      |  r4  |      |      | ~~S10\~~r4 |      |      |      |      |
|  16  |      |            |      |  r5  |      |      |     r5     |      |      |      |      |
|  17  |  S2  |            |      |      |      |      |            |  S3  |      |  20  |      |
|  18  |      |            |      |      |      |      |            |  S7  |      |      |  21  |
|  19  |      |            |      |      |      |      |            | S22  |      |      |      |
|  20  |      |            |      |      |      |      |            |      |  r1  |      |      |
|  21  |      |            |      | S23  |      |      |    S10     |      |      |      |      |
|  22  |      |     r3     |      |      |      |      |            |      |  r3  |      |      |
|  23  | S13  |            |      |      |      |      |            | S14  |      |  24  |      |
|  24  |      | ~~r2\~~S25 |      |      |      |      |            |      |  r2  |      |      |
|  25  | S13  |            |      |      |      |      |            | S14  |      |  26  |      |
|  26  |      |     r1     |      |      |      |      |            |      |  r1  |      |      |

### 解决冲突

由上面的 LR(1) 分析表可知，$ACTION(15,\&\&)$ 和 $ACTION(24,e)$ 存在冲突

- 规定 && 左结合
  - $I_{15}$ 的状态可表示为 $C\&\&C$  $\&\&C$
  - 由于 && 左结合，所以先规约栈中的 $C\&\&C$
  - 所以保留 $r_4$
- else-dangling
  - $I_24$ 的状态可表示为 $i(C)S$  $eS$
  - 根据 else-dangling 可知，需要将 $eS$ 压入栈中规约
  - 所以保留 $S_{25}$

冲突的解决在表中以删除线的形式显示

### 分析表代码化

除此之外，在实现中将产生式也进行了代码化，在次不再展示

![](./action-table.png)

![](./goto-table.png)

### 算法设计

- 语法分析器先从词法分析器获得解析后的 Token 序列
- 然后根据当前的 Token 和状态栈顶的状态，从 ACTION 表中取表项分析
  - 若取到空表项，说明发生错误，结束程序
- 之后根据表项首位是 S 或 r 进行相应的操作
  - S：进行状态转移，将当前 Token 和 下一个状态压栈
  - r：进行规约
    - 将规约式加入结果
    - 根据产生式右部的符号数对状态栈和 Token 栈进行出栈
    - 根据当前状态和 Token 栈的栈顶从 GOTO 表中获取下一个状态
    - 将下一个状态压栈，保持指针不动直接进入下一次循环
- 若输入流未结束，后移指针，进入下一次循环

## 异常处理

本程序中可能出现的异常共有两处

1. 查表时遇到 ""（ACTION 表），0（GOTO 表）：提示 "parse error: Token(?) cant match state(?)" 并显示当前的 Token 和状态栈顶以便定位错误
2. 产生式右侧是未知的非终结符，提示 "no such non-terminal: ?" 并显示无法解析的非终结符

## 问题与解决

- 直接使用词法分析程序传递过来的 Token 序列却无法得出正确结果
  - 在使用词法分析器传递过来的 Token 序列之前，要记得向其中添加 $ 对应的 Token！
- 调试时 r 操作后一步的栈状态和手动分析的时候不同
  - r 操作最后，要使用 continue 直接进入下一次循环，否则当前 Token 将未处理就被跳过，会造成程序错误

## 评价与感受

- 基本完成了既定的目标，虽然期间经历了巨大的坎坷，比如 DFA 从头开始画错等等，但结果还是比较令人满意的
- 一开始以为 5 条产生式应该不会有太大的工作量，没想到最后还是有多达 26 个状态，差点没顶住
- 对于 LR(1) 语法构建 DFA，构建表，解决冲突的过程更加熟悉；学会了如何构造程序使用 LR(1) 分析表完成语法分析任务